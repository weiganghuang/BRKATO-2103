- hosts: localhost
  # include_vars:
  # file: /Users/weigang/git/CNC-Automation/vm-install/roles/cdg-install/vars/main.yaml
  vars_files: 
    - "local.yml"
    - "main.yml"

  tasks:
    - name: deploy cdg
      vmware_deploy_ovf:
        hostname: '{{ vcenter_host }}'
        cluster: '{{ item.esxi_host }}'
        username: '{{ vcenter_username }}'
        password: '{{ vcenter_pw }}'
        datacenter: 'Cheynnne DC'
        datastore: '{{ item.ds }}'
        disk_provisioning: thin
        networks: "{u'vNIC0':u'{{ item.nics.nic0}}', u'vNIC1':u'{{ item.nics.nic1}}', u'vNIC2':u'{{ item.nics.nic2}}'}"
        name: '{{ item.vm_name }}' 
        ovf: '{{ cdg_ova }}' 
        wait_for_ip_address: false
        validate_certs: no
        inject_ovf_env: true
        deployment_option: onpremise-extended
        properties:
          Hostname: '{{ item.vm_name }}'
          Description:  'Description {{ item.vm_name }}'
          Label: 'Label {{ item.vm_name }}'
          ActiveVnics: '{{item.active_vnics}}'
          Vnic0IPv4Address: '{{item.vnic0_ip}}'
          Vnic0IPv4Gateway: '{{item.vnic0_gw}}'
          Vnic0IPv4Netmask: '{{item.vnic0_mask}}'
          Vnic1IPv4Address: '{{item.vnic1_ip}}'
          Vnic1IPv4Gateway: '{{item.vnic1_gw}}'
          Vnic1IPv4Netmask: '{{item.vnic1_mask}}'
          Vnic1IPv4Method:  'Static'
          ControllerIP: '{{ controller_ip}}'
          ControllerPort: 30603
          ControllerSignCertChain: '{{ controller_pem }}'
          ControllerCertChainPwd: '{{ controller_pw }}'
          DNS: '{{dns}}'
          NTP: '{{ntp}}'
          dg-adminPassword: "{{dg_admin_pw}}"
          dg-operPassword: "{{ dg_oper_pw}}"
          Domain: '{{domain}}'
      loop: '{{vms}}'
      delegate_to: localhost

    # - name: make template files
    #   ansible.builtin.debug:
    #     msg: "{{item}}"
    #   loop: "{{vms}}"

    # - name: create sh files

    #   template:
    #     src: "{{ ansible_env.HOME }}/git/CNC-Automation/vm-install/roles/cdg-install/templates/cdg-deploy-base.j2"
    #     dest: "{{ansible_env.HOME}}/ovftool/cdg-deploy-{{ item.vm_name }}-temp.sh"
    #   loop: "{{vms}}"

    
      
        
      
